## Context

这是一个全新的 Windows 桌面应用项目，用于个人日常任务管理。用户需要功能完整的本地化任务管理工具，支持复杂任务组织（无限层级子任务、任务依赖、文件关联等），同时保持良好的用户体验。

**约束条件:**
- Qt 5.15.2 (LTS 版本)
- 编译器: MSVC 2019 64位
- 数据库: SQLite (通过 QtSql 模块)
- 部署: 自包含 Release 文件夹，无第三方依赖
- 使用场景: 个人使用，任务量通常 < 500 个

**当前状态:**
- 项目尚未开始，无现有代码库
- 需要从零构建完整的 MVC 架构应用

## Goals / Non-Goals

**Goals:**
- 构建一个功能完整、用户体验良好的个人任务管理应用
- 支持无限层级子任务结构，灵活组织任务
- 提供高效的搜索和筛选功能
- 实现可靠的数据备份和恢复机制
- 支持深色/浅色主题切换
- 确保良好的性能（1000+ 任务流畅运行）
- 代码结构清晰，易于维护和扩展

**Non-Goals:**
- 不支持云端同步或多用户协作
- 不需要移动端适配
- 不支持自动化测试或 CI/CD
- 不考虑国际化（仅支持简体中文）
- 不需要实时通知（应用关闭时不推送通知）

## Decisions

### 1. UI 框架选择: QTreeView + QStandardItemModel

**决策:** 使用 QTreeView + QStandardItemModel 实现任务树视图

**理由:**
- 性能足够好（个人使用场景，任务量 < 1000）
- 支持 QSS 自定义样式，便于实现深色模式
- API 相对简单，Qt 官方文档完善
- 支持拖拽排序、展开折叠等核心功能
- 社区示例多，遇到问题容易找到解决方案

**考虑的替代方案:**
- **QTreeWidget**: 定制样式困难，QSS 支持有限，性能较差
- **QTreeView + QAbstractItemModel**: 开发复杂度高，对于本项目过度设计

### 2. 数据库: SQLite + FTS5 全文搜索

**决策:** 使用 SQLite 作为数据存储，启用 FTS5 全文搜索

**理由:**
- Qt 内置支持，无需额外依赖
- 单文件存储，易于备份和迁移
- FTS5 提供高效的全文搜索，支持中文分词
- 事务支持，保证数据一致性
- 足够的性能（1000 条记录查询 < 50ms）

**考虑的替代方案:**
- **内存存储**: 不持久化，数据丢失风险
- **JSON 文件**: 查询性能差，无法高效搜索

### 3. 任务层级结构: 递归 parent_id

**决策:** 使用递归 parent_id 实现无限层级

**理由:**
- 简单直接，SQL 支持递归查询（WITH RECURSIVE）
- 灵活支持任意层级深度
- 易于实现树的展开/折叠

**数据模型:**
```
tasks 表:
- id (主键)
- parent_id (自引用，NULL = 根任务)
- is_step (布尔值，区分任务/步骤)
```

### 4. 主题系统: QSS 样式表

**决策:** 使用 QSS (Qt Style Sheets) 实现深色/浅色主题

**理由:**
- Qt 原生支持，无需额外库
- 样式与代码分离，易于维护
- 支持动态切换（运行时加载新样式）
- 足够的灵活性实现卡片式设计

**主题配色:**
- 主色调: 蓝色系 (#3B82F6 深色，#2563EB 浅色)
- 优先级: 红/黄/绿 (#EF4444, #F59E0B, #10B981)
- 深色模式: slate-900 (#0F172A) 作为主背景
- 浅色模式: slate-50 (#F8FAFC) 作为主背景

### 5. 搜索策略: 实时搜索 + FTS5

**决策:** 实时搜索 + SQLite FTS5 全文索引

**理由:**
- 用户体验好，输入即搜
- FTS5 提供高性能全文搜索
- 支持中文分词（需要配置 tokenizer）
- 搜索结果相关性排序（bm25 算法）

**实现方式:**
- 创建 tasks_fts 虚拟表
- 使用触发器同步数据变更
- 搜索时 JOIN FTS 表，按相关性排序

### 6. 删除策略: 软删除 + 回收站

**决策:** 软删除到回收站，14天自动清理

**理由:**
- 防止误删，可恢复数据
- 用户明确需求（删除前 3 天通知）
- 定期清理避免数据膨胀

**删除流程:**
- 标记 is_deleted = 1，记录 deleted_at 时间
- 子任务提升为根任务（可配置）
- 检查设置: 级联删除 vs 子任务提升
- 定时任务清理超过 14 天的已删除任务

### 7. 备份策略: SQLite 完整备份

**决策:** 每天自动备份，保留 7 个版本

**理由:**
- SQLite 文件复制简单高效
- 保留历史版本，可回滚
- 可在设置中配置（频率、时间、保留数、路径）

**备份机制:**
- SQLite VACUUM 后备份
- 文件命名: todolist_backup_YYYYMMDD_HHMMSS.db
- 备份完成后通知用户

### 8. 架构: MVC 模式

**决策:** 采用 MVC (Model-View-Controller) 架构

**理由:**
- 关注点分离，代码清晰
- 数据与 UI 解耦，易于测试和维护
- 控制器集中业务逻辑

**组件划分:**
- **Models**: Task, TaskModel, Notification, Folder
- **Views**: MainWindow, Sidebar, TaskTree, TaskCard, Dialogs
- **Controllers**: TaskController, Database, BackupManager, NotificationManager
- **Utils**: Logger, DateUtils, FileUtils, ThemeUtils

### 9. 性能优化: 懒加载子任务

**决策:** 启动时加载根任务，展开时加载子任务

**理由:**
- 个人使用场景，任务量不会太大
- 减少启动时间
- 按需加载，节省内存

**实现方式:**
- QStandardItemModel 懒加载（使用 hasChildren 标记）
- 展开时动态查询数据库
- 缓存已加载的子任务

### 10. 窗口布局: 参考微软 ToDo

**决策:** 传统布局，侧边栏 + 主内容区，搜索框居中

**理由:**
- 用户熟悉的布局模式
- 侧边栏便于快速分组切换
- 居中搜索框突出核心功能

**窗口规格:**
- 默认: 1280x720 (720P)
- 最小: 1024x768
- 侧边栏: 280px（可拖拽调整，最小 220px）
- 支持最大化/全屏
- 记住上次位置和大小

## Risks / Trade-offs

### [Risk] SQLite 中文分词问题

**描述:** FTS5 默认分词器对中文支持不佳

**缓解措施:**
- 使用 unicode61 分词器
- 或考虑自定义简单分词（按空格和标点）
- 评估中文搜索效果，必要时切换到内存 LIKE 查询

### [Risk] 递归查询性能

**描述:** 深层级任务树可能导致递归查询性能下降

**缓解措施:**
- 个人使用场景，层级通常 < 5 层
- 使用 WITH RECURSIVE 优化查询
- 考虑缓存常用查询结果

### [Risk] QSS 样式兼容性

**描述:** 不同 Qt 版本 QSS 支持可能有差异

**缓解措施:**
- 使用 Qt 5.15.2 稳定版本
- 避免使用实验性 QSS 特性
- 在多个主题下测试样式

### [Risk] 文件路径跨平台问题

**描述:** Windows 路径可能包含反斜杠，未来扩展到其他平台

**缓解措施:**
- 使用 QDir/QFile 处理路径（Qt 自动处理分隔符）
- 避免硬编码路径分隔符
- 使用相对路径（相对于数据目录）

### [Risk] 数据库并发访问

**描述:** 多个进程同时访问 SQLite 可能锁定

**缓解措施:**
- 个人使用，单进程运行
- SQLite 默认允许多读单写
- 错误处理：重试机制

### [Trade-off] 懒加载 vs 完整加载

**描述:** 懒加载节省内存，但搜索需要全量数据

**权衡:**
- 选择懒加载（启动快）
- 搜索时触发全量加载（一次性）
- 后续可以考虑后台预加载

### [Trade-off] JSON vs SQLite 导出格式

**描述:** JSON 可读性好，SQLite 完整但不可读

**权衡:**
- 提供两种格式供选择
- JSON 适合迁移和查看
- SQLite 适合完整备份和恢复

## Migration Plan

### 开发阶段

**Phase 1: 项目初始化**
1. 创建 CMakeLists.txt
2. 配置 Qt 5.15.2 + MSVC 2019
3. 初始化数据库表结构
4. 实现基础日志系统

**Phase 2: 核心功能**
1. 实现 Task 数据模型
2. 实现 Database 控制器
3. 实现 MainWindow 和 Sidebar
4. 实现 TaskTree 和 TaskCard
5. 实现任务 CRUD 操作
6. 实现树形展示和展开折叠

**Phase 3: 增强功能**
1. 实现搜索筛选
2. 实现主题切换
3. 实现任务依赖显示
4. 实现文件关联
5. 实现进度跟踪
6. 实现侧边栏分组

**Phase 4: 高级功能**
1. 实现回收站（软删除）
2. 实现通知系统
3. 实现自动备份
4. 实现自定义文件夹
5. 实现导入导出
6. 实现设置系统

### 部署步骤

1. 编译 Release 版本: `cmake --build build --config Release`
2. 使用 windeployqt 打包: `windeployqt.exe build/Release/ToDoList.exe`
3. 复制资源文件（图标、QSS）
4. 创建 Release 文件夹结构
5. 压缩为 zip 文件分发

### 回滚策略

- 数据库损坏时: 从备份目录恢复
- 代码回滚: Git 版本控制
- 配置错误: 删除 settings.db，应用使用默认值

## Open Questions

（当前无待决策问题，所有关键决策已确定）
